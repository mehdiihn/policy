<!-- Generated by SpecStory -->

# Streamlining User Account Creation and Policy Management (2025-05-24 15:41:07)

_**User**_

Allow the admins to add policy for the user without needing to send him an email for confirmation etc.

Also as said the account should be automatically generated so scan the whole codebase and fix that because in the email template you say your password that you inserted but they never use one because we should auto generate the user

like i first told you in the project brief

Project Overview: Fake Insurance App (for demonstration purposes)

The app will have two main user roles: Admin and Sub-Admin.

🔒 Admin Portal
 • Full access to the system.
 • Can create and manage Sub-Admins and Users.

🔐 Sub-Admin Portal
 • Can create User accounts only.
 • Will have access to a form to enter user and policy details:
 • Full Name
 • Email
 • Password
 • Address
 • Date of Birth
 • Vehicle Registration
 • Last 4 digits of credit card
 • Policy Price

📄 After Sub-Admin Creates a Policy
 • A user account is automatically created.
 • A confirmation email is sent to the user with a PDF certificate showing their policy details.

📱 User App/Portal
 • Users can log in to view their:
 • Vehicle details
 • Insurance policy status and duration

---

_**Assistant**_



---

I'll help you fix the password auto-generation and admin policy creation issues. Let me first explore the codebase to understand the current structure and identify where changes need to be made.

---

<details>
            <summary>Listed current directory • **22** results</summary>
        
| Name |
|-------|
| 📁 `.next` |
| 📄 `tsconfig.tsbuildinfo` |
| 📄 `package-lock.json` |
| 📁 `node_modules` |
| 📄 `package.json` |
| 📄 `README.md` |
| 📄 `.env.local` |
| 📁 `.specstory` |
| 📁 `src` |
| 📄 `tailwind.config.ts` |
| 📄 `components.json` |
| 📁 `.git` |
| 📄 `.gitignore` |
| 📄 `.cursorignore` |
| 📁 `.cursor` |
| 📄 `.cursorindexingignore` |
| 📄 `tsconfig.json` |
| 📁 `public` |
| 📄 `next.config.ts` |
| 📄 `next-env.d.ts` |
| 📄 `postcss.config.mjs` |
| 📄 `eslint.config.mjs` |

</details>

---

<details>
            <summary>Listed directory src • **3** results</summary>
        
| Name |
|-------|
| 📁 `app` |
| 📁 `lib` |
| 📁 `components` |

</details>

---

<details>
            <summary>Listed directory src/app • **9** results</summary>
        
| Name |
|-------|
| 📁 `admin` |
| 📄 `page.tsx` |
| 📁 `api` |
| 📁 `register` |
| 📁 `user` |
| 📁 `sub-admin` |
| 📄 `globals.css` |
| 📄 `layout.tsx` |
| 📄 `favicon.ico` |

</details>

---

<details>
            <summary>Listed directory src/app/api • **6** results</summary>
        
| Name |
|-------|
| 📁 `admin` |
| 📁 `register-admin` |
| 📁 `setup` |
| 📁 `user` |
| 📁 `sub-admin` |
| 📁 `auth` |

</details>

---

<details>
            <summary>Listed directory src/app/api/user • **1** results</summary>
        
| Name |
|-------|
| 📁 `profile` |

</details>

---

<details>
            <summary>Listed directory src/app/api/sub-admin • **1** results</summary>
        
| Name |
|-------|
| 📁 `policies` |

</details>

---

<details>
            <summary>Listed directory src/app/api/sub-admin/policies • **1** results</summary>
        
| Name |
|-------|
| 📄 `route.ts` |

</details>

---

<details>
            <summary>Listed directory src/app/api/admin • **2** results</summary>
        
| Name |
|-------|
| 📁 `policies` |
| 📁 `users` |

</details>

---

<details>
            <summary>Listed directory src/app/api/admin/policies • **1** results</summary>
        
| Name |
|-------|
| 📄 `route.ts` |

</details>

---

<details>
            <summary>Listed directory src/app/api/admin/users • **2** results</summary>
        
| Name |
|-------|
| 📄 `route.ts` |
| 📁 `[id]` |

</details>

---

Now let me examine the key files to understand the current implementation:

---

Read file: src/app/api/sub-admin/policies/route.ts

---

Read file: src/app/api/sub-admin/policies/route.ts

---

Read file: src/app/api/admin/policies/route.ts

---

Read file: src/app/api/admin/users/route.ts

---

Read file: src/app/api/admin/users/route.ts

---

Now let me check the email template to see what needs to be fixed:

---

<details>
            <summary>Searched codebase "sendPolicyEmail email template password" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/lib/email.ts` | L45-82 |
| `src/lib/email.ts` | L1-45 |
| `src/lib/email.ts` | L82-154 |
| `src/app/sub-admin/create-policy/page.tsx` | L176-220 |
| `src/app/admin/create-policy/page.tsx` | L176-220 |
| `src/app/api/sub-admin/policies/route.ts` | L156-219 |
| `src/lib/email.ts` | L270-338 |
| `src/app/api/sub-admin/policies/route.ts` | L1-39 |
| `src/lib/email.ts` | L154-198 |
| `src/app/sub-admin/create-policy/page.tsx` | L89-152 |
| `src/app/admin/create-policy/page.tsx` | L89-152 |
| `src/lib/email.ts` | L198-270 |
| `README.md` | L179-269 |
| `src/app/sub-admin/create-policy/page.tsx` | L152-176 |
| `src/app/admin/create-policy/page.tsx` | L152-176 |
| `src/app/sub-admin/create-policy/page.tsx` | L220-270 |
| `src/app/admin/create-policy/page.tsx` | L220-270 |
| `src/app/sub-admin/create-policy/page.tsx` | L538-559 |
| `src/app/sub-admin/create-policy/page.tsx` | L1-89 |
| `src/app/admin/create-policy/page.tsx` | L1-89 |
| `src/app/user/page.tsx` | L188-228 |
| `src/app/admin/create-policy/page.tsx` | L537-558 |
| `src/app/admin/page.tsx` | L52-75 |
| `src/app/sub-admin/page.tsx` | L99-127 |
| `package.json` | L1-52 |

</details>

---

Now I can see the issues clearly! Let me create a utility function to generate passwords and update the relevant files:

---

<details>
            <summary>Searched codebase "lib utils" • **7** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Perfect! Let me check the utils file and add the password generation function:

---

Read file: src/lib/utils.ts

---

Now let me add the password generation function to the utils file:

---

```diff
    return twMerge(clsx(inputs))
  }
+ 
+ /**
+  * Generates a secure random password
+  * @param length - Length of the password (default: 12)
+  * @returns A randomly generated password
+  */
+ export function generatePassword(length: number = 12): string {
+   const lowercase = 'abcdefghijklmnopqrstuvwxyz';
+   const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
+   const numbers = '0123456789';
+   const symbols = '!@#$%&*';
+   
+   const allChars = lowercase + uppercase + numbers + symbols;
+   
+   let password = '';
+   
+   // Ensure at least one character from each category
+   password += lowercase[Math.floor(Math.random() * lowercase.length)];
+   password += uppercase[Math.floor(Math.random() * uppercase.length)];
+   password += numbers[Math.floor(Math.random() * numbers.length)];
+   password += symbols[Math.floor(Math.random() * symbols.length)];
+   
+   // Fill the rest with random characters
+   for (let i = 4; i < length; i++) {
+     password += allChars[Math.floor(Math.random() * allChars.length)];
+   }
+   
+   // Shuffle the password
+   return password.split('').sort(() => Math.random() - 0.5).join('');
+ }
  
```

---

Now let me fix the email template to reflect that the password is auto-generated:

---

```diff
            <div style="background-color: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0;">
              <p><strong>Email:</strong> ${user.email}</p>
-             <p><strong>Password:</strong> The password you provided during registration</p>
+             <p><strong>Password:</strong> ${user.tempPassword || user.password}</p>
              <p><strong>Portal URL:</strong> <a href="${
                process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000"
```

```diff
        }</a></p>
            </div>
+           
+           <p><strong>Important:</strong> Please log in and change your password after your first login for security purposes.</p>
            
            <p>You can log in to view your policy details, vehicle information, and policy status at any time.</p>
```

---

Now let me update the sub-admin policy creation endpoint to use auto-generated passwords:

---

```diff
  import { requireAuth } from "@/lib/auth";
  import { sendPolicyEmail } from "@/lib/email";
+ import { generatePassword } from "@/lib/utils";
  
  export async function GET(request: NextRequest) {
```

```diff
      const formData = await request.json();
  
-     // Validate required fields
+     // Validate required fields (removed password from required fields)
      const requiredFields = [
        "fullName",
        "email",
-       "password",
        "address",
        "dateOfBirth",
```

```diff
        );
      }
+ 
+     // Generate password automatically
+     const generatedPassword = generatePassword();
  
      // Create new user
      const newUser = new User({
        fullName: formData.fullName,
        email: formData.email.toLowerCase(),
-       password: formData.password,
+       password: generatedPassword,
        role: "user",
        address: formData.address,
```

```diff
  
      await newUser.save();
+ 
+     // Store the plain password temporarily for email (will be cleaned up)
+     newUser.tempPassword = generatedPassword;
  
      // Create policy
```

---

Now let me create a new admin policy creation endpoint specifically for admins to add policies without email confirmation:

---

```diff
  import connectToDatabase from "@/lib/mongodb";
  import Policy from "@/lib/models/Policy";
+ import User from "@/lib/models/User";
  import { requireAuth } from "@/lib/auth";
+ import { generatePassword } from "@/lib/utils";
  
  export async function GET(request: NextRequest) {
```

```diff
    }
  }
+ 
+ export async function POST(request: NextRequest) {
+   try {
+     const authResult = await requireAuth(["admin"])(request);
+ 
+     if ("error" in authResult) {
+       return NextResponse.json(
+         { error: authResult.error },
+         { status: authResult.status }
+       );
+     }
+ 
+     const formData = await request.json();
+     const { sendEmail = false } = formData; // Option to send email or not
+ 
+     // Validate required fields (removed password from required fields)
+     const requiredFields = [
+       "fullName",
+       "email",
+       "address",
+       "dateOfBirth",
+       "vehicleRegistration",
+       "lastFourDigits",
+       "price",
+       "endDate",
+       "make",
+       "model",
+       "colour",
+       "yearOfManufacture",
+     ];
+ 
+     for (const field of requiredFields) {
+       if (!formData[field]) {
+         return NextResponse.json(
+           { error: `${field} is required` },
+           { status: 400 }
+         );
+       }
+     }
+ 
+     await connectToDatabase();
+ 
+     // Check if user already exists
+     const existingUser = await User.findOne({
+       email: formData.email.toLowerCase(),
+     });
+     if (existingUser) {
+       return NextResponse.json(
+         { error: "User with this email already exists" },
+         { status: 400 }
+       );
+     }
+ 
+     // Generate password automatically
+     const generatedPassword = generatePassword();
+ 
+     // Create new user
+     const newUser = new User({
+       fullName: formData.fullName,
+       email: formData.email.toLowerCase(),
+       password: generatedPassword,
+       role: "user",
+       address: formData.address,
+       dateOfBirth: new Date(formData.dateOfBirth),
+       vehicleRegistration: formData.vehicleRegistration,
+       lastFourDigits: formData.lastFourDigits,
+       createdBy: authResult.user.userId,
+     });
+ 
+     await newUser.save();
+ 
+     // Create policy
+     const newPolicy = new Policy({
+       userId: newUser._id,
+       price: parseFloat(formData.price),
+       endDate: new Date(formData.endDate),
+       vehicleInfo: {
+         make: formData.make,
+         model: formData.model,
+         colour: formData.colour,
+         yearOfManufacture: parseInt(formData.yearOfManufacture),
+         topSpeed: formData.topSpeed,
+         acceleration: formData.acceleration,
+         gearbox: formData.gearbox,
+ 
+         // Engine & Fuel
+         power: formData.power,
+         maxTorque: formData.maxTorque,
+         engineCapacity: formData.engineCapacity,
+         cylinders: formData.cylinders
+           ? parseInt(formData.cylinders)
+           : undefined,
+         fuelType: formData.fuelType,
+         consumptionCity: formData.consumptionCity,
+         consumptionExtraUrban: formData.consumptionExtraUrban,
+         consumptionCombined: formData.consumptionCombined,
+         co2Emission: formData.co2Emission,
+         co2Label: formData.co2Label,
+ 
+         // MOT Information
+         motExpiryDate: formData.motExpiryDate
+           ? new Date(formData.motExpiryDate)
+           : undefined,
+         motPassRate: formData.motPassRate,
+         motPassed: formData.motPassed
+           ? parseInt(formData.motPassed)
+           : undefined,
+         motFailed: formData.motFailed
+           ? parseInt(formData.motFailed)
+           : undefined,
+         totalAdviceItems: formData.totalAdviceItems
+           ? parseInt(formData.totalAdviceItems)
+           : undefined,
+         totalItemsFailed: formData.totalItemsFailed
+           ? parseInt(formData.totalItemsFailed)
+           : undefined,
+ 
+         // Tax & MOT Status
+         taxStatus: formData.taxStatus,
+         taxDue: formData.taxDue ? new Date(formData.taxDue) : undefined,
+ 
+         // Safety Ratings
+         ncapRating: {
+           adult: formData.ncapAdult,
+           children: formData.ncapChildren,
+           pedestrian: formData.ncapPedestrian,
+           safetySystems: formData.ncapSafetySystems,
+           overall: formData.ncapOverall,
+         },
+ 
+         // Dimensions & Weight
+         dimensions: {
+           width: formData.width,
+           height: formData.height,
+           length: formData.length,
+           wheelBase: formData.wheelBase,
+           maxAllowedWeight: formData.maxAllowedWeight,
+         },
+ 
+         // Additional Information
+         fuelTankCapacity: formData.fuelTankCapacity,
+         fuelDelivery: formData.fuelDelivery,
+         numberOfDoors: formData.numberOfDoors
+           ? parseInt(formData.numberOfDoors)
+           : undefined,
+         numberOfSeats: formData.numberOfSeats
+           ? parseInt(formData.numberOfSeats)
+           : undefined,
+         numberOfAxles: formData.numberOfAxles
+           ? parseInt(formData.numberOfAxles)
+           : undefined,
+         engineNumber: formData.engineNumber,
+       },
+       createdBy: authResult.user.userId,
+     });
+ 
+     await newPolicy.save();
+ 
+     // Optional: Send confirmation email with PDF (only if sendEmail is true)
+     if (sendEmail) {
+       try {
+         const { sendPolicyEmail } = await import("@/lib/email");
+         newUser.tempPassword = generatedPassword;
+         await sendPolicyEmail(newUser, newPolicy);
+       } catch (emailError) {
+         console.error("Error sending email:", emailError);
+         // Don't fail the entire operation if email fails
+       }
+     }
+ 
+     return NextResponse.json({
+       message: "Policy created successfully",
+       credentials: {
+         email: newUser.email,
+         password: generatedPassword,
+       },
+       policy: {
+         _id: newPolicy._id,
+         policyNumber: newPolicy.policyNumber,
+         userId: {
+           _id: newUser._id,
+           fullName: newUser.fullName,
+           email: newUser.email,
+         },
+         price: newPolicy.price,
+         status: newPolicy.status,
+         startDate: newPolicy.startDate,
+         endDate: newPolicy.endDate,
+       },
+     });
+   } catch (error) {
+     console.error("Error creating policy:", error);
+     return NextResponse.json(
+       { error: "Internal server error" },
+       { status: 500 }
+     );
+   }
+ }
  
```

---

Now let me update the admin user creation endpoint to also auto-generate passwords:

---

```diff
  import Policy from "@/lib/models/Policy";
  import { requireAuth } from "@/lib/auth";
+ import { generatePassword } from "@/lib/utils";
  
  export async function GET(request: NextRequest) {
```

```diff
      } = requestData;
  
-     if (!fullName || !email || !password || !role) {
+     if (!fullName || !email || !role) {
        return NextResponse.json(
-         { error: "All fields are required" },
+         { error: "Full name, email, and role are required" },
          { status: 400 }
        );
```

```diff
        );
      }
+ 
+     // Use provided password or generate one automatically
+     const finalPassword = password || generatePassword();
  
      // Create new user with role-specific fields
      const userData: any = {
        fullName,
        email: email.toLowerCase(),
-       password,
+       password: finalPassword,
        role,
        createdBy: authResult.user.userId,
```

```diff
      await newUser.save();
  
-     // Return user without password
+     // Return user without password but include generated password if it was auto-generated
      const userResponse = {
        _id: newUser._id,
```

```diff
          lastFourDigits: newUser.lastFourDigits,
        }),
+       ...(!password && { generatedPassword: finalPassword }), // Include generated password in response
      };
  
```

---

Now let me update the sub-admin create policy form to remove the password field:

---

```diff
      fullName: "",
      email: "",
-     password: "",
      address: "",
      dateOfBirth: "",
```

```diff
                    />
                  </div>
-                 <div className="space-y-2">
-                   <Label htmlFor="password">Password *</Label>
-                   <Input
-                     id="password"
-                     type="password"
-                     value={formData.password}
-                     onChange={(e) =>
-                       handleInputChange("password", e.target.value)
-                     }
-                     required
-                     minLength={6}
-                   />
-                 </div>
                  <div className="space-y-2">
                    <Label htmlFor="dateOfBirth">Date of Birth *</Label>
```

---

Now let me update the admin create policy form to also remove the password field:

---

```diff
      fullName: "",
      email: "",
-     password: "",
      address: "",
      dateOfBirth: "",
```

```diff
    const [error, setError] = useState("");
    const [success, setSuccess] = useState("");
+   const [sendEmail, setSendEmail] = useState(false);
+   const [credentials, setCredentials] = useState<{email: string, password: string} | null>(null);
    const router = useRouter();
  
```

```diff
                    />
                  </div>
-                 <div className="space-y-2">
-                   <Label htmlFor="password">Password *</Label>
-                   <Input
-                     id="password"
-                     type="password"
-                     value={formData.password}
-                     onChange={(e) =>
-                       handleInputChange("password", e.target.value)
-                     }
-                     required
-                     minLength={6}
-                   />
-                 </div>
                  <div className="space-y-2">
                    <Label htmlFor="dateOfBirth">Date of Birth *</Label>
```

---

Now let me update the admin form's submit handler and add the email option checkbox:

---

```diff
      setError("");
      setSuccess("");
+     setCredentials(null);
  
      try {
-       const response = await fetch("/api/sub-admin/policies", {
+       const response = await fetch("/api/admin/policies", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
-         body: JSON.stringify(formData),
+         body: JSON.stringify({
+           ...formData,
+           sendEmail,
+         }),
        });
  
```

```diff
        if (response.ok) {
          setSuccess(
-           "Policy created successfully! User account created and confirmation email sent."
+           `Policy created successfully! ${sendEmail ? "User account created and confirmation email sent." : "User credentials shown below."}`
          );
+         if (!sendEmail && data.credentials) {
+           setCredentials(data.credentials);
+         }
          setTimeout(() => {
            router.push("/admin");
-         }, 3000);
+         }, 5000);
        } else {
          setError(data.error || "Failed to create policy");
```

---



Now let me add the email option checkbox and credentials display to the admin form:

---

```diff
                </div>
              )}
+ 
+             {credentials && (
+               <div className="bg-blue-50 border border-blue-200 rounded-md p-4">
+                 <h3 className="text-sm font-medium text-blue-800 mb-2">
+                   User Login Credentials
+                 </h3>
+                 <div className="text-sm text-blue-700">
+                   <p><strong>Email:</strong> {credentials.email}</p>
+                   <p><strong>Password:</strong> {credentials.password}</p>
+                   <p className="mt-2 text-xs">
+                     Please save these credentials securely. The user can log in with these details.
+                   </p>
+                 </div>
+               </div>
+             )}
+ 
+             {/* Email Option */}
+             <Card>
+               <CardHeader>
+                 <CardTitle>Email Options</CardTitle>
+                 <CardDescription>
+                   Choose whether to send confirmation email to the user
+                 </CardDescription>
+               </CardHeader>
+               <CardContent>
+                 <div className="flex items-center space-x-2">
+                   <input
+                     type="checkbox"
+                     id="sendEmail"
+                     checked={sendEmail}
+                     onChange={(e) => setSendEmail(e.target.checked)}
+                     className="rounded border-gray-300"
+                   />
+                   <Label htmlFor="sendEmail">
+                     Send confirmation email with PDF certificate
+                   </Label>
+                 </div>
+                 <p className="text-sm text-gray-600 mt-2">
+                   If unchecked, user credentials will be displayed here instead of being emailed.
+                 </p>
+               </CardContent>
+             </Card>
  
              <div className="flex justify-end space-x-4">
```

---



---

